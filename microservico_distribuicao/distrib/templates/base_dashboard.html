{% load static %}
{% now "U" as ts %}
<!doctype html>
<html lang="pt-br">
  <head>
    <!-- APLICA O TEMA ANTES DO CSS (mata o flash) -->
    <script>
      (function () {
        var saved = localStorage.getItem('theme') || 'light';
        var html = document.documentElement;
        html.setAttribute('data-theme', saved);
        // desliga transições no 1º paint
        html.classList.add('no-theme-transition');
      })();
    </script>
    <script>
      (function () {
        try {
          if (localStorage.getItem('sidebar_collapsed') === '1') {
            document.documentElement.classList.add('sidebar-collapsed');
          }
        } catch(e){}
      })();
    </script>


    <meta charset="utf-8">
    <title>{% block title %}Distribuição · Painel{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + FA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Estilos do app (premium + dark) -->
    <link href="{% static 'css/app.css' %}?v={{ ts }}" rel="stylesheet">
    <link href="{% static 'css/app.css' %}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
  </head>
  <body class="app-bg">
    <div class="layout-wrap">
      {% include "partials/_sidebar.html" %}
      <div class="layout-content">
        {% include "partials/_topbar.html" %}
        <main class="container-fluid py-3 py-md-4">
          {% block content %}{% endblock %}
        </main>
        {% include "partials/_footer.html" %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- REATIVA SUAVEMENTE AS TRANSIÇÕES APÓS O PRIMEIRO PAINT -->
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var html = document.documentElement;
        html.classList.remove('no-theme-transition');
        html.classList.add('theme-animate');
      });
    </script>

    <!-- SEU SCRIPT DE TEMA (mantido), agora sem flicker -->
    <script>
      (function () {
        const STORAGE_KEY = "theme";
        const ATTR = "data-theme";
        const html = document.documentElement;

        function setTheme(next) {
          html.setAttribute(ATTR, next);
          localStorage.setItem(STORAGE_KEY, next);
          const icon = document.getElementById("themeIcon");
          const label = document.getElementById("themeLabel");
          if (icon) {
            icon.classList.remove("spin-in");
            icon.classList.add("spin-out");
            icon.addEventListener("transitionend", function onOut() {
              icon.className = (next === "dark" ? "fa fa-sun theme-icon" : "fa fa-moon theme-icon");
              requestAnimationFrame(() => icon.classList.add("spin-in"));
              icon.removeEventListener("transitionend", onOut);
            }, { once: true });
          }
          if (label) label.textContent = (next === "dark" ? "Alternar para tema claro" : "Alternar para tema escuro");
        }

        function getCurrentTheme() {
          return html.getAttribute(ATTR) || "light";
        }

        document.addEventListener("DOMContentLoaded", () => {
          const saved = localStorage.getItem(STORAGE_KEY) || "light";
          // já foi aplicado no head; aqui só garante o ícone correto
          const icon = document.getElementById("themeIcon");
          if (icon) icon.className = (saved === "dark" ? "fa fa-sun theme-icon" : "fa fa-moon theme-icon");

          const btn = document.getElementById("themeToggle");
          if (btn) {
            btn.addEventListener("click", () => {
              const next = getCurrentTheme() === "light" ? "dark" : "light";
              setTheme(next);
            });
          }
        });
      })();
    </script>
    <script>
      (function () {
        const STORAGE_KEY = "sidebar_collapsed";
        const html = document.documentElement;
        const btn  = document.getElementById("sidebarToggle");
        const sidebar = document.getElementById("appSidebar");

        function applyState(collapsed) {
          if (collapsed) {
            html.classList.add("sidebar-collapsed");
            if (btn) { btn.setAttribute("aria-expanded", "false"); btn.title = "Expandir"; }
            if (sidebar) sidebar.setAttribute("aria-expanded", "false");
          } else {
            html.classList.remove("sidebar-collapsed");
            if (btn) { btn.setAttribute("aria-expanded", "true"); btn.title = "Recolher"; }
            if (sidebar) sidebar.setAttribute("aria-expanded", "true");
          }
          try { localStorage.setItem(STORAGE_KEY, collapsed ? "1" : "0"); } catch(e){}
        }
        if (typeof window.__sidebarTooltipsUpdate === 'function') window.__sidebarTooltipsUpdate();

        document.addEventListener("DOMContentLoaded", function(){
          let saved = "0";
          try { saved = localStorage.getItem(STORAGE_KEY) || "0"; } catch(e){}
          applyState(saved === "1");

          if (btn) {
            btn.addEventListener("click", function(){
              const collapsed = !html.classList.contains("sidebar-collapsed");
              applyState(collapsed);
            });
          }
        });
      })();
    </script>
    <script>
      (function(){
        let tts = [];
        function updateTooltips(){
          // limpa os existentes
          tts.forEach(t => t.dispose());
          tts = [];
          const collapsed = document.documentElement.classList.contains('sidebar-collapsed');
          if (!collapsed) return;
          document.querySelectorAll('.sidebar [data-bs-toggle="tooltip"]').forEach(el=>{
            tts.push(new bootstrap.Tooltip(el, {
              placement: 'right',
              boundary: 'viewport',
              fallbackPlacements: ['right', 'bottom'],
              delay: { show: 60, hide: 40 }
            }));
          });
        }
        // expõe para o script do toggle chamar também
        window.__sidebarTooltipsUpdate = updateTooltips;
        document.addEventListener('DOMContentLoaded', updateTooltips);
      })();
    </script>
    <script src="{% static 'js/theme-charts.js' %}"></script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
