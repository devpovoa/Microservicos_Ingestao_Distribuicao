{% load static %}
<!doctype html>
<html lang="pt-br">
  <head>
    <!-- APLICA O TEMA ANTES DO CSS (mata o flash) -->
    <script>
      (function () {
        var saved = localStorage.getItem('theme') || 'light';
        var html = document.documentElement;
        html.setAttribute('data-theme', saved);
        // desliga transições no 1º paint
        html.classList.add('no-theme-transition');
      })();
    </script>

    <meta charset="utf-8">
    <title>{% block title %}Distribuição · Painel{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + FA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Estilos do app (premium + dark) -->
    <link href="{% static 'css/app.css' %}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
  </head>
  <body class="app-bg">
    <div class="layout-wrap">
      {% include "partials/_sidebar.html" %}
      <div class="layout-content">
        {% include "partials/_topbar.html" %}
        <main class="container-fluid py-3 py-md-4">
          {% block content %}{% endblock %}
        </main>
        {% include "partials/_footer.html" %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- REATIVA SUAVEMENTE AS TRANSIÇÕES APÓS O PRIMEIRO PAINT -->
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var html = document.documentElement;
        html.classList.remove('no-theme-transition');
        html.classList.add('theme-animate');
      });
    </script>

    <!-- SEU SCRIPT DE TEMA (mantido), agora sem flicker -->
    <script>
      (function () {
        const STORAGE_KEY = "theme";
        const ATTR = "data-theme";
        const html = document.documentElement;

        function setTheme(next) {
          html.setAttribute(ATTR, next);
          localStorage.setItem(STORAGE_KEY, next);
          const icon = document.getElementById("themeIcon");
          const label = document.getElementById("themeLabel");
          if (icon) {
            icon.classList.remove("spin-in");
            icon.classList.add("spin-out");
            icon.addEventListener("transitionend", function onOut() {
              icon.className = (next === "dark" ? "fa fa-sun theme-icon" : "fa fa-moon theme-icon");
              requestAnimationFrame(() => icon.classList.add("spin-in"));
              icon.removeEventListener("transitionend", onOut);
            }, { once: true });
          }
          if (label) label.textContent = (next === "dark" ? "Alternar para tema claro" : "Alternar para tema escuro");
        }

        function getCurrentTheme() {
          return html.getAttribute(ATTR) || "light";
        }

        document.addEventListener("DOMContentLoaded", () => {
          const saved = localStorage.getItem(STORAGE_KEY) || "light";
          // já foi aplicado no head; aqui só garante o ícone correto
          const icon = document.getElementById("themeIcon");
          if (icon) icon.className = (saved === "dark" ? "fa fa-sun theme-icon" : "fa fa-moon theme-icon");

          const btn = document.getElementById("themeToggle");
          if (btn) {
            btn.addEventListener("click", () => {
              const next = getCurrentTheme() === "light" ? "dark" : "light";
              setTheme(next);
            });
          }
        });
      })();
    </script>

    <script src="{% static 'js/theme-charts.js' %}"></script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
